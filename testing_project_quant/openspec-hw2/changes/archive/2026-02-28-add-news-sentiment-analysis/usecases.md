## Use Cases

### Use Case: 获取有色金属板块最新新闻

**Primary Actor:** 量化交易系统（自动化流程）
**Scope:** 新闻数据采集模块
**Level:** Subfunction

**Stakeholders and Interests:**
- 交易员 — 希望系统自动获取最新的板块和个股新闻，无需人工搜索
- 系统运维 — 希望采集过程稳定，不因数据源异常导致整个信号生成流程中断

**Preconditions:**
- 网络可用，能访问财经数据源（AKShare 等）
- 股票池（universe）已加载，系统知道需要关注哪些个股

**Success Guarantee (Postconditions):**
- 最新的有色金属板块新闻已抓取并存入本地数据库
- 新闻已去重，同一条新闻不会重复存储
- 每条新闻包含标题、摘要、发布时间、关联股票代码（如有）

**Trigger:** 交易信号生成流程启动时，系统自动触发新闻采集

**Main Success Scenario:**
1. 系统根据配置确定需要采集的新闻源和时间范围（默认最近 24 小时）
2. 系统调用 AKShare 财经新闻接口，按"有色金属"关键词获取板块新闻列表
3. 系统对每条新闻提取标题、摘要、发布时间等结构化字段
4. 系统根据股票池中的个股名称和代码，将新闻与具体个股关联
5. 系统对新闻进行去重（基于标题+发布时间），过滤已存在的新闻
6. 系统将新增新闻写入本地 SQLite 数据库的 news 表

**Extensions:**
- 2a. AKShare 接口请求失败：系统记录警告日志，跳过本次新闻采集，信号生成流程继续（使用历史新闻或不使用情绪因子）
- 2b. 接口返回空数据：系统记录 info 日志，标记无新增新闻，后续情绪分数使用最近一次的缓存值
- 4a. 新闻无法关联到具体个股：标记为板块级新闻，情绪分数将均匀分配给板块内所有个股

---

### Use Case: 分析新闻情绪（利多/利空判断）

**Primary Actor:** 量化交易系统（自动化流程）
**Scope:** LLM 情绪分析模块
**Level:** Subfunction

**Stakeholders and Interests:**
- 交易员 — 希望系统准确判断新闻对股价的影响方向，减少人工阅读新闻的工作量
- 系统运维 — 希望 LLM 调用成本可控，不因大量新闻导致 API 费用失控

**Preconditions:**
- 本地数据库中存在待分析的新闻（未生成情绪分数的新闻）
- LLM API key 已通过环境变量配置
- 网络可用，能访问 LLM API 服务

**Success Guarantee (Postconditions):**
- 每条待分析新闻都生成了情绪分类（利多/利空/中性）和情绪分数（-1 到 +1）
- 分析结果已缓存到 sentiment_cache 表，同一条新闻不会重复调用 LLM

**Trigger:** 新闻采集完成后，系统自动触发情绪分析

**Main Success Scenario:**
1. 系统从数据库中查询所有未分析的新闻
2. 系统将新闻按批次组织（每批最多 N 条），构造 LLM prompt
3. 系统调用 LLM API，发送新闻标题和摘要，要求返回结构化的情绪判断
4. LLM 返回每条新闻的情绪分类（bullish/bearish/neutral）和置信度分数
5. 系统将 LLM 返回结果解析为标准化情绪分数（利多 → 正值，利空 → 负值）
6. 系统将结果写入 sentiment_cache 表，标记这些新闻为已分析

**Extensions:**
- 3a. LLM API 调用失败（网络错误/限流）：系统等待后重试（最多 2 次），仍失败则跳过这批新闻，记录警告
- 3b. LLM API key 未配置：系统记录错误日志，跳过整个情绪分析步骤，信号生成流程不使用情绪因子
- 4a. LLM 返回格式不符合预期：系统尝试容错解析，无法解析的新闻标记为中性（分数 0）
- 1a. 无待分析新闻：系统跳过 LLM 调用，直接使用历史缓存的情绪分数

---

### Use Case: 生成包含情绪因子的交易信号

**Primary Actor:** 交易员
**Scope:** 量化交易系统（信号生成流程）
**Level:** User goal

**Stakeholders and Interests:**
- 交易员 — 希望交易信号综合考虑量化因子和新闻情绪，提高信号质量
- 风控 — 希望情绪因子不会导致过度交易或集中持仓

**Preconditions:**
- 市场数据已更新（股票行情、基本面数据等）
- 股票池已确定

**Success Guarantee (Postconditions):**
- 系统输出的交易信号已融合情绪因子
- 情绪因子在多因子打分中占据配置的权重比例
- 信号中包含情绪相关的辅助信息（最新利多/利空新闻摘要）

**Trigger:** 交易员执行 `python main.py signal` 命令

**Main Success Scenario:**
1. 交易员运行信号生成命令
2. 系统获取股票池和最新行情数据
3. 系统采集最新有色金属新闻（调用 news-fetcher）
4. 系统对未分析的新闻调用 LLM 进行情绪判断（调用 llm-sentiment-analyzer）
5. 系统计算每只股票的情绪因子分数（聚合该股相关新闻的情绪值，应用时间衰减）
6. 系统将情绪因子与其他因子（commodity/fundamental/technical/flow/macro）一起输入多因子打分
7. 系统根据综合得分生成 BUY/SELL/ADD/REDUCE 交易信号
8. 系统输出信号列表，附带每只股票的情绪标签和关键新闻摘要

**Extensions:**
- 3a. 新闻采集失败：系统继续生成信号，但不包含情绪因子（回退到纯量化因子）
- 4a. LLM 分析失败：系统使用最近一次缓存的情绪分数，如无缓存则情绪因子权重归零
- 5a. 某只股票无相关新闻：该股票的情绪因子分数设为 0（中性），不影响其他因子得分
- 6a. 配置中 sentiment 权重为 0：系统完全跳过新闻采集和情绪分析步骤，行为与修改前一致

**Open Questions:**
- LLM 选择哪家服务商（OpenAI / Anthropic / 国产大模型）？是否需要支持多个？
- 情绪因子的时间衰减半衰期设为多少合适（12 小时 / 24 小时 / 48 小时）？
- 是否需要在信号输出中显示触发情绪变化的具体新闻内容？
