## Context

构建一套面向A股有色金属板块的多因子量化交易系统。当前无现有代码基础，为全新项目（greenfield）。系统目标用户为量化研究员，通过CLI接口进行日常操作（数据更新、因子计算、回测、报告生成）。

核心约束：
- A股T+1交易规则、10%涨跌停限制、停牌处理
- 数据源API调用频率限制（AKShare免费但有限速）
- 有色金属板块的细分行业映射需要领域知识

## Goals / Non-Goals

**Goals:**
- 模块化架构，每个子系统独立可测试
- 支持完整的量化研究流程：数据→因子→策略→风控→回测→报告
- 真实模拟A股交易环境（T+1、交易成本、涨跌停）
- 配置驱动，关键参数可通过 YAML 配置文件调整

**Non-Goals:**
- 不做实盘交易接口（仅回测和研究）
- 不做高频交易（日频策略）
- 不做Web界面（CLI + HTML报告即可）
- 不做多市场支持（仅A股）

## Decisions

### Decision 1: 模块化 Python 包结构

**选择**: 按功能领域拆分为 7 个独立模块（data / universe / factors / strategy / risk / backtest / report）+ 1 个 timing 模块

**理由**: 每个模块对应一个清晰的职责边界，便于独立开发和测试。因子引擎不需要知道回测逻辑，风控模块不需要知道报告生成。

**备选方案**:
- 单文件实现：简单但随着功能增长迅速变得不可维护
- 微服务架构：过度设计，本地研究工具不需要网络通信开销

### Decision 2: AKShare 作为主数据源 + 双备份

**选择**: AKShare（主）→ BaoStock（备）→ Tushare（备），自动降级切换

**理由**: AKShare 免费无需注册、覆盖面广（股票/期货/宏观/资金流）。BaoStock 免费但数据类型较少。Tushare 需要积分但数据质量高。三者互补覆盖所有需求。

**备选方案**:
- 仅用 AKShare：单点故障风险
- Wind/Bloomberg：需要付费License，不适合个人研究

### Decision 3: SQLite 本地缓存

**选择**: SQLite 文件数据库，按数据类型分表存储

**理由**: 零配置、文件便携、Python内置支持。量化研究的数据量（数百只股票 × 数年日频）在SQLite性能范围内。

**备选方案**:
- PostgreSQL：需要安装配置，对于本地研究工具过重
- Parquet 文件：读写快但不支持灵活查询和增量更新

### Decision 4: 事件驱动回测架构

**选择**: 日频事件循环，每日按固定顺序处理事件（价格更新→风控检查→订单执行→调仓→记录NAV）

**理由**: 事件驱动架构天然支持T+1规则（订单队列）和涨跌停处理（执行前检查），逻辑清晰且易于调试。

**备选方案**:
- 向量化回测（vectorbt风格）：速度快但难以准确模拟T+1和涨跌停等复杂交易规则

### Decision 5: 配置化因子权重体系

**选择**: YAML 配置文件定义因子权重，支持运行时切换等权/IC加权模式

**理由**: 量化研究需要频繁调整参数，YAML可读性好，修改不需要改代码。

### Decision 6: Plotly 报告可视化

**选择**: Plotly 生成交互式 HTML 报告

**理由**: 交互式图表支持缩放、悬停查看数据点，比静态图更适合量化分析。HTML文件可直接浏览器打开，无需额外服务。

**备选方案**:
- Matplotlib：仅静态图，交互性差
- Streamlit dashboard：需要运行server，部署复杂

## Risks / Trade-offs

- **[数据源不稳定]** → AKShare等免费数据源可能API变动或限速；缓解：三源降级 + 本地缓存最小化调用
- **[因子过拟合]** → 16个因子在有色金属小样本上可能过拟合；缓解：IC加权模式动态调整、保持因子逻辑的经济学意义
- **[回测偏差]** → 历史数据可能存在幸存者偏差（退市股票缺失）；缓解：在报告中标注此局限性
- **[性能瓶颈]** → 大量API调用和因子计算可能较慢；缓解：SQLite缓存 + 增量更新

## Open Questions

- IC加权模式的回望窗口应设为多长？（暂定12个月）
- 是否需要支持自定义因子扩展接口？（暂不支持，待后续需求）
- 北向资金数据的个股粒度是否可靠获取？（需验证AKShare数据覆盖度）
