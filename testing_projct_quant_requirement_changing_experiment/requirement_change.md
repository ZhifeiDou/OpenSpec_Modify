# 需求变更文档：波动率自适应风控升级

## 背景

2024 年有色金属市场经历了剧烈波动，铜价在 Q2 出现了近 30% 的快速上涨后又急剧回调，铝、锌等品种同样出现大幅波动。在此期间，我们的量化交易系统暴露出以下问题：

1. **固定止损参数反应迟钝**：固定的 2x ATR 止损（或固定 8% 止损）在高波动期间无法及时保护头寸，多次出现在大幅回撤后才触发止损的情况
2. **固定再平衡频率不够灵活**：月度再平衡在市场剧烈变动时间隔太长，错过了及时调整仓位的最佳窗口
3. **缺乏极端行情保护机制**：系统没有整体层面的"熔断"机制，在单日大幅亏损时无法快速降低风险敞口

产品经理根据客户反馈和市场复盘，提出以下三项需求变更。

---

## 需求1：波动率自适应止损

### 现状
- OpenSpec 版：固定 2x ATR 止损
- 非 OpenSpec 版：固定 8% 止损

### 变更要求

引入**波动率比值**的概念：计算近 20 个交易日的日收益率标准差，与过去 120 个交易日（约半年）的日收益率标准差中位数比较，得到 `volatility_ratio`。

根据 `volatility_ratio` 动态调整止损参数：

| 波动率状态 | 条件 | OpenSpec版止损 | 非OpenSpec版止损 |
|-----------|------|---------------|-----------------|
| 低波动 | ratio < 0.8 | 1.5x ATR | 6% |
| 正常波动 | 0.8 ≤ ratio ≤ 1.5 | 2.0x ATR（不变） | 8%（不变） |
| 高波动 | ratio > 1.5 | 2.5x ATR | 10% |

### 边界情况
- 历史数据不足 120 天时：使用可用数据计算中位数，若不足 20 天则回退到固定参数
- 波动率比值突变（如隔夜跳空）：使用收盘价计算，不含盘中极值

---

## 需求2：动态再平衡频率

### 现状
- OpenSpec 版：固定月度再平衡（每月第一个交易日）
- 非 OpenSpec 版：固定每 20 个交易日再平衡

### 变更要求

根据 `volatility_ratio`（同需求1中的计算方式）自动调整再平衡频率：

| 波动率状态 | 条件 | 再平衡频率 |
|-----------|------|-----------|
| 正常波动 | ratio ≤ 1.5 | 月度（不变） |
| 高波动 | 1.5 < ratio ≤ 2.0 | 双周（每两周第一个交易日） |
| 极端波动 | ratio > 2.0 | 周度（每周第一个交易日） |

### 边界情况
- 波动率状态在月内变化：以当前最新的 volatility_ratio 为准，动态调整下一次再平衡日期
- 频率切换时与上一次再平衡间隔：切换到更高频率时立即生效（如从月度切到双周，不需要等到下一个月）

---

## 需求3：极端行情熔断机制（全新功能）

### 功能描述

引入组合级别的"熔断"机制，当组合净值（NAV）出现大幅单日下跌时，自动降低风险敞口。

### 具体规则

| 触发条件 | 操作 |
|---------|------|
| 组合单日净值下跌 > 3% | **一级熔断**：所有持仓减半（卖出各持仓 50% 的股数） |
| 组合单日净值下跌 > 5% | **二级熔断**：触发全部清仓 |

### 熔断恢复规则
- 一级熔断后：需连续 **3 个交易日** 组合净值相比熔断日净值回升（即每日净值 > 熔断日净值），方可恢复到正常仓位水平
- 二级熔断后：需连续 **5 个交易日** 净值回升方可恢复
- 恢复时逐步恢复：先恢复到 50% 仓位，再经过一次正常再平衡恢复到 100%

### 边界情况
- **熔断与 T+1 冲突**：若熔断触发日部分股票是当日买入（T+0），这些股票因 T+1 规则无法当日卖出，应在次日第一时间执行减仓/清仓
- **熔断期间再平衡**：熔断状态下暂停正常再平衡，直到恢复正常状态
- **连续触发**：若一级熔断后次日继续大跌超过 5%，升级为二级熔断（全部清仓）
- **熔断日计算方式**：当日净值变化 = (当日NAV - 前一日NAV) / 前一日NAV

---

## 涉及模块分析

### OpenSpec 版预计影响
| 模块 | 影响类型 | 说明 |
|------|---------|------|
| risk-management spec | MODIFIED | 新增波动率自适应止损规则、熔断机制 |
| backtest-engine spec | MODIFIED | 支持动态再平衡频率、集成熔断逻辑 |
| market-timing spec | 可能 MODIFIED | 仓位比例受熔断状态影响 |
| src/risk/stop_loss.py | 修改 | 波动率自适应止损 |
| src/risk/drawdown.py | 修改 | 增加熔断逻辑 |
| src/risk/alerts.py | 修改 | 新增熔断检查函数 |
| src/backtest/engine.py | 修改 | 动态再平衡、熔断集成 |
| config/settings.yaml | 修改 | 新增配置参数 |
| tests/risk/ | 新增 | 新增测试用例 |

### 非 OpenSpec 版预计影响
| 文件 | 说明 |
|------|------|
| backtester.py | 止损、再平衡、熔断逻辑全部在此文件修改 |
| config.py | 新增相关参数 |
| strategy.py | 可能涉及 |

---

## 验收标准

1. 三项需求均完整实现
2. 代码无语法错误，逻辑正确
3. 所有边界情况均有处理
4. （OpenSpec版）测试覆盖所有核心场景
