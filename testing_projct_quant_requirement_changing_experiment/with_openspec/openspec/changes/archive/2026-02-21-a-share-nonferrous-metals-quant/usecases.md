## Use Cases

### Use Case: Update Market Data

**Primary Actor:** Investor (量化用户)
**Scope:** A股有色金属量化系统
**Level:** User goal

**Stakeholders and Interests:**
- Investor — 获取最新的行情、财务、商品、宏观、资金流数据，确保因子计算基于最新信息

**Preconditions:**
- 系统已完成初始化，数据源（AKShare/BaoStock/Tushare）可用
- 本地数据库已创建

**Success Guarantee (Postconditions):**
- 本地数据库包含截至最近交易日的所有数据
- 增量更新成功，未重复下载已有数据
- 数据质量检查通过（无缺失关键字段）

**Trigger:** 用户执行数据更新命令，或定时任务触发

**Main Success Scenario:**
1. 用户发起数据更新请求，可选择更新全部或指定数据类别
2. 系统检查本地数据库中各类数据的最后更新日期
3. 系统从 AKShare 拉取增量行情数据（日K线、分钟线）
4. 系统从 AKShare/BaoStock 拉取增量财务报表数据
5. 系统从 AKShare 拉取商品期货价格（SHFE铜/铝/锌/镍/锡/铅、LME对应品种）及库存数据
6. 系统从 AKShare 拉取宏观指标（PMI、汇率、M1、社融）及资金流数据（融资融券、北向资金）
7. 系统对新数据执行质量检查（字段完整性、价格范围合理性、日期连续性）
8. 系统将通过检查的数据写入本地存储，记录更新时间戳
9. 系统输出更新摘要（各类数据更新条数、耗时、异常记录数）

**Extensions:**
- 3a. 数据源 API 请求失败：系统重试 2 次，若仍失败则记录错误并跳过该数据源，继续其他数据源的拉取
- 3b. 数据源返回空数据（非交易日）：系统记录并跳过，不视为错误
- 7a. 数据质量检查发现异常（如价格为负、字段缺失）：系统标记异常记录，输出警告，不写入主表

---

### Use Case: Manage Stock Universe

**Primary Actor:** Investor
**Scope:** A股有色金属量化系统
**Level:** User goal

**Stakeholders and Interests:**
- Investor — 获取准确的有色金属板块成分股列表，了解子板块分布

**Preconditions:**
- 行情数据已更新至最新交易日

**Success Guarantee (Postconditions):**
- 股票池包含当前有色金属板块所有有效成分股
- ST、停牌、上市不满60天的股票已被剔除
- 每只股票标注了子板块归属（铜/铝/黄金/稀土/锂/钴镍/锌铅）

**Trigger:** 用户请求刷新股票池，或在月度调仓前自动触发

**Main Success Scenario:**
1. 用户发起股票池更新请求
2. 系统从申万行业分类获取有色金属一级行业（801050）全部成分股
3. 系统获取申万二级行业分类，将成分股映射到子板块
4. 系统剔除 ST/*ST 股票、当日停牌股票、上市不满 60 个交易日的股票
5. 系统剔除日均成交额低于 500 万元的股票（流动性过滤）
6. 系统输出最终股票池，包含代码、名称、子板块、市值等信息

**Extensions:**
- 2a. 申万行业分类数据获取失败：系统回退到上一次成功获取的成分股列表
- 5a. 用户自定义流动性阈值：系统按用户指定的最低日均成交额过滤

---

### Use Case: Calculate Factor Values

**Primary Actor:** Investor
**Scope:** A股有色金属量化系统
**Level:** User goal

**Stakeholders and Interests:**
- Investor — 获取股票池中所有股票的最新因子值，用于后续打分选股

**Preconditions:**
- 本地数据已更新至最新交易日
- 股票池已刷新

**Success Guarantee (Postconditions):**
- 股票池中每只股票的五大类因子值均已计算并存储
- 因子值经过截面标准化（Z-Score）处理

**Trigger:** 用户发起因子计算命令，或在月度调仓流程中自动触发

**Main Success Scenario:**
1. 用户发起因子计算请求，可指定计算日期（默认最新交易日）
2. 系统加载当前股票池
3. 系统计算基本面因子：PB 3年分位数、毛利率环比变化、ROE_TTM、EV/EBITDA
4. 系统计算技术因子：60日动量（跳过最近5日）、5日反转、20日换手率比、20日已实现波动率
5. 系统计算商品因子：对应金属品种 SHFE 60日价格动量、期货升贴水、LME/SHFE库存周变化率
6. 系统计算宏观因子：PMI 环比方向、美元指数20日动量、M1同比增速方向
7. 系统计算资金流因子：个股融资余额5日变化率、北向资金10日净买入额
8. 系统对每个因子在截面上做去极值（MAD 法）和 Z-Score 标准化
9. 系统输出因子矩阵（股票 x 因子）并存储

**Extensions:**
- 3a. 某只股票财务数据缺失（如未披露最新财报）：系统使用上一期财务数据，并标记为"滞后"
- 5a. 某金属品种期货数据缺失：系统使用现货价格替代，并发出警告
- 8a. 截面股票数量不足（< 10只）：系统警告样本量过小，建议扩大股票池

---

### Use Case: Generate Trading Signals

**Primary Actor:** Investor
**Scope:** A股有色金属量化系统
**Level:** User goal

**Stakeholders and Interests:**
- Investor — 获取明确的买入/卖出/持仓建议及目标仓位

**Preconditions:**
- 因子值已计算完毕
- 当前持仓信息已录入（首次运行可为空仓）

**Success Guarantee (Postconditions):**
- 输出目标持仓列表（股票代码、目标权重）
- 输出相对当前持仓的调仓指令（买入/卖出/调整）
- 择时信号和总仓位比例已确定

**Trigger:** 月度调仓日到达，或用户手动触发信号生成

**Main Success Scenario:**
1. 用户发起交易信号生成请求
2. 系统执行商品动量择时判断：检查 SHFE 铜/铝 20日和60日动量，确定总仓位系数（1.0/0.6/0.3/0.2）
3. 系统加载因子矩阵，按权重计算每只股票的综合得分（商品35%/基本面25%/技术20%/资金流15%/宏观5%）
4. 系统按得分排序，选出前 N 只股票（N = min(10, 股票池20%)）
5. 系统根据得分和总仓位系数分配各股票目标权重，单票上限 10%，子板块上限 25%
6. 系统与当前持仓对比，生成调仓指令（新买入、加仓、减仓、清仓）
7. 系统估算调仓的交易成本
8. 系统输出信号报告：目标持仓、调仓指令、择时状态、预估成本

**Extensions:**
- 2a. 所有金属价格动量均为负：系统建议极低仓位（20%），优先配置黄金子板块
- 5a. 某子板块权重超过25%上限：系统自动降低该子板块内低分股票的权重，将额度分配给其他子板块
- 6a. 调仓比例极小（< 2%）：系统建议跳过本次调仓以节省交易成本

---

### Use Case: Execute Daily Risk Check

**Primary Actor:** System (定时任务)
**Scope:** A股有色金属量化系统
**Level:** User goal

**Stakeholders and Interests:**
- Investor — 在非调仓日也能及时发现风险并收到预警

**Preconditions:**
- 当日行情数据已更新
- 有活跃持仓

**Success Guarantee (Postconditions):**
- 所有持仓的止损条件已检查
- 组合回撤已计算并与阈值对比
- 触发条件的预警已发出

**Trigger:** 每个交易日收盘后自动运行

**Main Success Scenario:**
1. 系统拉取当日收盘数据
2. 系统检查每只持仓股票是否触发硬止损（亏损 > 2倍ATR，约8%）
3. 系统检查盈利持仓是否触发移动止损（从最高点回落 > 8%）
4. 系统计算组合当前回撤水平
5. 系统检查金属期货价格是否出现急跌（单日跌幅 > 3%）
6. 系统生成风控报告：各持仓盈亏状态、组合回撤、预警事项
7. 系统将报告保存并通知用户

**Extensions:**
- 2a. 个股触发硬止损：系统标记该股票为"待卖出"，在报告中高亮提示
- 4a. 组合回撤超过15%：系统建议减仓至50%，标记为"紧急"
- 4b. 组合回撤超过20%：系统建议全部清仓，标记为"严重"
- 5a. 金属价格急跌：系统列出受影响的持仓并建议检查

---

### Use Case: Run Strategy Backtest

**Primary Actor:** Investor
**Scope:** A股有色金属量化系统
**Level:** User goal

**Stakeholders and Interests:**
- Investor — 在实盘前验证策略的历史表现，评估收益风险特征

**Preconditions:**
- 历史数据已覆盖回测区间
- 策略参数已配置

**Success Guarantee (Postconditions):**
- 回测结果包含完整的绩效指标（年化收益、夏普比率、最大回撤、胜率）
- 回测严格遵守 A 股交易规则（T+1、涨跌停、交易成本）
- 输出逐日净值曲线和每笔交易记录

**Trigger:** 用户指定回测参数（起止日期、初始资金）并发起回测

**Main Success Scenario:**
1. 用户指定回测参数：起止日期、初始资金、调仓频率、因子权重
2. 系统验证历史数据覆盖所需区间
3. 系统按时间推进回测：在每个调仓日执行选股和仓位分配
4. 系统在每个交易日检查止损和风控条件
5. 系统对每笔交易扣除交易成本（印花税0.05% + 佣金万三 + 滑点0.15%）
6. 系统处理 A 股特殊规则：T+1（买入次日才能卖出）、涨停无法买入、跌停无法卖出、停牌处理
7. 系统使用当时的行业成分股（非当前成分股）以避免幸存者偏差
8. 系统计算绩效指标并输出回测报告

**Extensions:**
- 2a. 历史数据不足：系统提示需要先运行数据更新命令补充历史数据
- 6a. 某交易日目标股票涨停无法买入：系统跳过该股票，资金保留为现金
- 6b. 某交易日持仓股票跌停无法卖出：系统延迟到可卖出日执行卖出

---

### Use Case: View Performance Report

**Primary Actor:** Investor
**Scope:** A股有色金属量化系统
**Level:** User goal

**Stakeholders and Interests:**
- Investor — 直观了解策略表现、持仓分布、因子有效性

**Preconditions:**
- 已有回测结果或实盘运行记录

**Success Guarantee (Postconditions):**
- 生成包含绩效走势、持仓明细、因子暴露、回撤分析的可视化报告

**Trigger:** 用户请求查看报告

**Main Success Scenario:**
1. 用户请求生成报告，指定数据来源（回测结果或实盘记录）
2. 系统绘制净值曲线（策略 vs 有色金属指数基准）
3. 系统生成持仓一览表（当前/历史持仓、子板块分布饼图）
4. 系统生成因子暴露热力图（各因子对组合收益的贡献）
5. 系统生成回撤分析图（水下曲线、最大回撤区间标注）
6. 系统生成因子 IC 跟踪图（各因子的滚动 IC 值）
7. 系统输出核心指标摘要：年化收益、夏普比率、最大回撤、胜率、换手率

**Extensions:**
- 1a. 数据量不足（< 1个月）：系统提示数据过少，报告仅输出基础指标
- 4a. 用户请求导出报告：系统将图表保存为 HTML 或 PNG 文件

---

### Use Case: Configure Strategy Parameters

**Primary Actor:** Investor
**Scope:** A股有色金属量化系统
**Level:** User goal

**Stakeholders and Interests:**
- Investor — 根据个人风险偏好和研究结论调整策略参数

**Preconditions:**
- 系统已初始化

**Success Guarantee (Postconditions):**
- 新参数已保存并在下次调仓/回测时生效
- 参数变更历史有记录

**Trigger:** 用户希望调整因子权重、风控阈值或调仓频率

**Main Success Scenario:**
1. 用户查看当前策略参数配置
2. 用户修改目标参数（如因子权重、止损阈值、最大持股数、调仓频率等）
3. 系统验证参数合法性（权重之和为1、阈值在合理范围内）
4. 系统保存新参数并记录变更时间
5. 系统显示参数变更对比（旧值 → 新值）

**Extensions:**
- 3a. 参数不合法（如权重之和不为1）：系统提示错误并拒绝保存
- 2a. 用户选择恢复默认参数：系统加载内置默认配置

**Open Questions:**
- 是否支持多套参数配置的切换（如"保守"/"激进"预设）？
