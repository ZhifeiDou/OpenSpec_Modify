<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A股有色金属 · 多因子量化机器人</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
:root {
  --bg: #0f1923;
  --card: #162736;
  --border: #1e3a4f;
  --text: #c8d6e5;
  --text-dim: #6b8299;
  --accent: #00d4aa;
  --red: #ff6b6b;
  --yellow: #ffd93d;
  --blue: #4dabf7;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: -apple-system, "Microsoft YaHei", sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
}
.header {
  background: linear-gradient(135deg, #0a2647, #144272);
  padding: 18px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
}
.header h1 { font-size: 20px; font-weight: 600; }
.header h1 span { color: var(--accent); }
.btn {
  padding: 8px 20px;
  border: 1px solid var(--accent);
  background: transparent;
  color: var(--accent);
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
}
.btn:hover { background: var(--accent); color: var(--bg); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-red { border-color: var(--red); color: var(--red); }
.btn-red:hover { background: var(--red); color: #fff; }
.btn-group { display: flex; gap: 10px; }

.container { padding: 20px 32px; max-width: 1600px; margin: 0 auto; }

/* 指标卡片 */
.metrics-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}
.metric-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
}
.metric-card .label { font-size: 12px; color: var(--text-dim); }
.metric-card .value { font-size: 24px; font-weight: 700; margin-top: 4px; }
.positive { color: var(--accent); }
.negative { color: var(--red); }

/* 网格布局 */
.grid-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}
@media(max-width:1000px){ .grid-2{ grid-template-columns:1fr; } }

.panel {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}
.panel-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  font-weight: 600;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.panel-body { padding: 16px; }

/* 表格 */
table { width:100%; border-collapse:collapse; font-size:13px; }
th, td { padding:8px 10px; text-align:left; border-bottom:1px solid var(--border); }
th { color: var(--text-dim); font-weight:500; position:sticky; top:0; background:var(--card); }
.table-wrap { max-height: 400px; overflow-y: auto; }

/* 信号标签 */
.signal-tag {
  display: inline-block;
  padding: 2px 10px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}
.signal-buy { background: rgba(0,212,170,0.15); color: var(--accent); }
.signal-sell { background: rgba(255,107,107,0.15); color: var(--red); }
.signal-hold { background: rgba(255,217,61,0.15); color: var(--yellow); }

/* 图表容器 */
.chart { width:100%; height:400px; }
.chart-tall { height: 500px; }

/* 权重滑块 */
.weight-controls { display:flex; flex-wrap:wrap; gap:14px; }
.weight-item { flex:1; min-width:200px; }
.weight-item label { display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px; }
.weight-item input[type=range] {
  width:100%; accent-color: var(--accent);
  -webkit-appearance: none; height:6px; border-radius:3px;
  background: var(--border);
}

/* 状态信息 */
.status-bar {
  padding: 10px 32px;
  background: var(--card);
  border-top: 1px solid var(--border);
  font-size: 12px;
  color: var(--text-dim);
  text-align: center;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
}

#loading {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(15,25,35,0.85);
  z-index: 999;
  justify-content: center;
  align-items: center;
  font-size: 18px;
}
#loading.show { display: flex; }
.spinner {
  width: 36px; height: 36px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 14px;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="header">
  <h1><span>&#9670;</span> A股有色金属 · 多因子量化机器人</h1>
  <div class="btn-group">
    <button class="btn" onclick="refreshData()">刷新数据 &amp; 计算因子</button>
    <button class="btn btn-red" onclick="runBacktest()">运行回测</button>
  </div>
</div>

<div id="loading">
  <div class="spinner"></div>
  <span id="loading-text">加载中...</span>
</div>

<div class="container">

  <!-- 绩效指标卡片 -->
  <div class="metrics-row" id="metrics-row">
    <div class="metric-card"><div class="label">总收益率</div><div class="value" id="m-total-return">--</div></div>
    <div class="metric-card"><div class="label">年化收益率</div><div class="value" id="m-annual-return">--</div></div>
    <div class="metric-card"><div class="label">最大回撤</div><div class="value" id="m-max-dd">--</div></div>
    <div class="metric-card"><div class="label">夏普比率</div><div class="value" id="m-sharpe">--</div></div>
    <div class="metric-card"><div class="label">胜率</div><div class="value" id="m-winrate">--</div></div>
    <div class="metric-card"><div class="label">盈亏比</div><div class="value" id="m-plr">--</div></div>
    <div class="metric-card"><div class="label">股票池数量</div><div class="value" id="m-stock-count">--</div></div>
  </div>

  <!-- 资金曲线 -->
  <div class="panel" style="margin-bottom:20px;">
    <div class="panel-header">资金曲线 (策略 vs 沪深300基准)</div>
    <div class="panel-body"><div class="chart chart-tall" id="chart-equity"></div></div>
  </div>

  <div class="grid-2">
    <!-- 因子评分排名 -->
    <div class="panel">
      <div class="panel-header">因子评分排名</div>
      <div class="panel-body table-wrap">
        <table>
          <thead><tr>
            <th>排名</th><th>代码</th><th>名称</th><th>综合评分</th>
            <th>动量5d</th><th>MACD</th><th>RSI</th><th>PE%</th><th>ROE</th><th>资金流</th>
          </tr></thead>
          <tbody id="factor-table"></tbody>
        </table>
      </div>
    </div>

    <!-- 交易信号 -->
    <div class="panel">
      <div class="panel-header">交易信号</div>
      <div class="panel-body table-wrap">
        <table>
          <thead><tr><th>代码</th><th>名称</th><th>信号</th><th>评分</th><th>原因</th></tr></thead>
          <tbody id="signal-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="grid-2" style="margin-top:20px;">
    <!-- K线图表 -->
    <div class="panel">
      <div class="panel-header">
        个股K线
        <select id="kline-select" onchange="loadKline()" style="background:var(--bg);color:var(--text);border:1px solid var(--border);padding:4px 8px;border-radius:4px;">
          <option value="">-- 选择股票 --</option>
        </select>
      </div>
      <div class="panel-body"><div class="chart" id="chart-kline"></div></div>
    </div>

    <!-- 因子权重调节 -->
    <div class="panel">
      <div class="panel-header">因子权重调节</div>
      <div class="panel-body">
        <div class="weight-controls" id="weight-controls"></div>
        <div style="margin-top:16px;text-align:right;">
          <button class="btn" onclick="applyWeights()">应用权重 &amp; 重新计算</button>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="status-bar" id="status-bar">就绪 — 点击「刷新数据」开始</div>

<script>
// ── 全局状态 ──
const weights = {
  momentum: 0.20, technical: 0.25, value: 0.20, quality: 0.15, money_flow: 0.20
};
const weightLabels = {
  momentum: "动量因子", technical: "技术因子", value: "价值因子",
  quality: "质量因子", money_flow: "资金流向"
};

// ── 工具函数 ──
function showLoading(msg) {
  document.getElementById("loading-text").textContent = msg || "加载中...";
  document.getElementById("loading").classList.add("show");
}
function hideLoading() {
  document.getElementById("loading").classList.remove("show");
}
function setStatus(msg) {
  document.getElementById("status-bar").textContent = msg;
}
function colorVal(v, el) {
  el.className = "value " + (v > 0 ? "positive" : v < 0 ? "negative" : "");
}

// ── 初始化权重滑块 ──
function initWeightControls() {
  const container = document.getElementById("weight-controls");
  container.innerHTML = "";
  for (const [key, val] of Object.entries(weights)) {
    const div = document.createElement("div");
    div.className = "weight-item";
    div.innerHTML = `
      <label><span>${weightLabels[key]}</span><span id="wv-${key}">${(val*100).toFixed(0)}%</span></label>
      <input type="range" min="0" max="50" value="${val*100}" step="1"
             oninput="weights['${key}']=this.value/100; document.getElementById('wv-${key}').textContent=this.value+'%'">
    `;
    container.appendChild(div);
  }
}

// ── 刷新数据 ──
async function refreshData() {
  showLoading("正在获取数据并计算因子评分...");
  setStatus("正在刷新数据...");
  try {
    const resp = await fetch("/api/refresh", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({weights})
    });
    const data = await resp.json();
    if (!data.ok) { alert("刷新失败: " + data.error); return; }
    setStatus(data.message);
    await Promise.all([loadFactors(), loadSignals(), loadUniverse()]);
  } catch(e) {
    alert("请求失败: " + e);
  } finally {
    hideLoading();
  }
}

// ── 加载因子评分 ──
async function loadFactors() {
  const resp = await fetch("/api/factors");
  const data = await resp.json();
  if (!data.ok) return;
  const tbody = document.getElementById("factor-table");
  tbody.innerHTML = "";
  data.data.forEach(row => {
    const tr = document.createElement("tr");
    tr.style.cursor = "pointer";
    tr.onclick = () => { document.getElementById("kline-select").value = row.code; loadKline(); };
    tr.innerHTML = `
      <td>${row.rank||''}</td>
      <td>${row.code}</td>
      <td>${row.name||''}</td>
      <td class="${row.composite_score>0?'positive':'negative'}">${(row.composite_score||0).toFixed(4)}</td>
      <td>${(row.ret_5d||0).toFixed(3)}</td>
      <td>${(row.macd||0).toFixed(3)}</td>
      <td>${(row.rsi||0).toFixed(3)}</td>
      <td>${(row.pe_percentile||0).toFixed(3)}</td>
      <td>${(row.roe||0).toFixed(3)}</td>
      <td>${(row.main_net_inflow||0).toFixed(3)}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ── 加载信号 ──
async function loadSignals() {
  const resp = await fetch("/api/signals");
  const data = await resp.json();
  if (!data.ok) return;
  const tbody = document.getElementById("signal-table");
  tbody.innerHTML = "";
  data.data.forEach(row => {
    const cls = row.signal === "buy" ? "signal-buy" : row.signal === "sell" ? "signal-sell" : "signal-hold";
    const label = row.signal === "buy" ? "买入" : row.signal === "sell" ? "卖出" : "持有";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.code}</td>
      <td>${row.name||''}</td>
      <td><span class="signal-tag ${cls}">${label}</span></td>
      <td class="${row.score>0?'positive':'negative'}">${row.score}</td>
      <td style="font-size:12px;color:var(--text-dim)">${row.reason||''}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ── 加载股票池 → 填充K线选择器 ──
async function loadUniverse() {
  const resp = await fetch("/api/universe");
  const data = await resp.json();
  if (!data.ok) return;
  const select = document.getElementById("kline-select");
  select.innerHTML = '<option value="">-- 选择股票 --</option>';
  data.data.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.code;
    opt.textContent = `${s.code} ${s.name||''}`;
    select.appendChild(opt);
  });
  document.getElementById("m-stock-count").textContent = data.data.length;
}

// ── K线图 ──
async function loadKline() {
  const code = document.getElementById("kline-select").value;
  if (!code) return;
  const resp = await fetch(`/api/kline/${code}`);
  const data = await resp.json();
  if (!data.ok || !data.data.length) return;

  const dates = data.data.map(d => d.date);
  const ohlc = data.data.map(d => [d.open, d.close, d.low, d.high]);
  const volumes = data.data.map(d => d.volume);

  const chart = echarts.init(document.getElementById("chart-kline"));
  chart.setOption({
    tooltip: { trigger: "axis", axisPointer: { type: "cross" } },
    grid: [
      { left: 50, right: 20, top: 20, height: "55%" },
      { left: 50, right: 20, top: "72%", height: "20%" }
    ],
    xAxis: [
      { type: "category", data: dates, gridIndex: 0, axisLabel:{color:"#6b8299",fontSize:10} },
      { type: "category", data: dates, gridIndex: 1, axisLabel:{show:false} }
    ],
    yAxis: [
      { scale: true, gridIndex: 0, splitLine:{lineStyle:{color:"#1e3a4f"}}, axisLabel:{color:"#6b8299"} },
      { scale: true, gridIndex: 1, splitLine:{lineStyle:{color:"#1e3a4f"}}, axisLabel:{color:"#6b8299"} }
    ],
    series: [
      {
        type: "candlestick", data: ohlc, xAxisIndex: 0, yAxisIndex: 0,
        itemStyle: { color: "#ff4d4f", color0: "#00d4aa", borderColor: "#ff4d4f", borderColor0: "#00d4aa" }
      },
      {
        type: "bar", data: volumes, xAxisIndex: 1, yAxisIndex: 1,
        itemStyle: { color: "#4dabf7", opacity: 0.5 }
      }
    ]
  });
}

// ── 回测 ──
async function runBacktest() {
  showLoading("正在运行回测，请稍候...");
  setStatus("正在回测...");
  try {
    const resp = await fetch("/api/run_backtest", { method: "POST" });
    const data = await resp.json();
    if (!data.ok) { alert("回测失败: " + data.error); return; }
    renderBacktest(data.data);
    setStatus("回测完成");
  } catch(e) {
    alert("回测失败: " + e);
  } finally {
    hideLoading();
  }
}

function renderBacktest(result) {
  const m = result.metrics || {};

  // 更新指标卡片
  const pairs = [
    ["m-total-return", m.total_return, "%"],
    ["m-annual-return", m.annual_return, "%"],
    ["m-max-dd", -m.max_drawdown, "%"],
    ["m-sharpe", m.sharpe_ratio, ""],
    ["m-winrate", m.win_rate, "%"],
    ["m-plr", m.profit_loss_ratio, ""],
  ];
  pairs.forEach(([id, v, suffix]) => {
    const el = document.getElementById(id);
    if (v !== undefined && v !== null) {
      el.textContent = v + suffix;
      colorVal(v, el);
    }
  });

  // 资金曲线
  const eq = result.equity_curve || [];
  const bm = result.benchmark_curve || [];
  const dates = eq.map(e => e.date);
  const eqValues = eq.map(e => e.equity);

  const bmMap = {};
  bm.forEach(b => bmMap[b.date] = b.equity);
  const bmValues = dates.map(d => bmMap[d] || null);

  const chart = echarts.init(document.getElementById("chart-equity"));
  chart.setOption({
    tooltip: { trigger: "axis" },
    legend: { data: ["策略净值", "沪深300基准"], textStyle: {color: "#c8d6e5"}, top: 10 },
    grid: { left: 60, right: 20, top: 50, bottom: 30 },
    xAxis: { type: "category", data: dates, axisLabel:{color:"#6b8299",fontSize:10} },
    yAxis: { type: "value", scale: true, splitLine:{lineStyle:{color:"#1e3a4f"}}, axisLabel:{color:"#6b8299"} },
    series: [
      { name:"策略净值", type:"line", data:eqValues, smooth:true,
        lineStyle:{color:"#00d4aa",width:2}, areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,
        colorStops:[{offset:0,color:"rgba(0,212,170,0.3)"},{offset:1,color:"rgba(0,212,170,0)"}]}},
        symbol:"none" },
      { name:"沪深300基准", type:"line", data:bmValues, smooth:true,
        lineStyle:{color:"#4dabf7",width:1.5,type:"dashed"}, symbol:"none" }
    ]
  });
}

// ── 应用权重 ──
async function applyWeights() {
  showLoading("正在以新权重重新计算...");
  try {
    const resp = await fetch("/api/refresh", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({weights})
    });
    const data = await resp.json();
    if (!data.ok) { alert("计算失败: " + data.error); return; }
    setStatus("权重已更新 — " + data.message);
    await Promise.all([loadFactors(), loadSignals()]);
  } catch(e) {
    alert("失败: " + e);
  } finally {
    hideLoading();
  }
}

// ── 页面初始化 ──
initWeightControls();

// 窗口resize时重新调整图表大小
window.addEventListener("resize", () => {
  ["chart-equity", "chart-kline"].forEach(id => {
    const el = document.getElementById(id);
    const inst = echarts.getInstanceByDom(el);
    if (inst) inst.resize();
  });
});
</script>
</body>
</html>
